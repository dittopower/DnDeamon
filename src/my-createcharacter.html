<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-createcharacter">
    <template>
        <style include="shared-styles">
             :host {
                display: block;
                padding: 10px;
            }

            .scoresTable h3 {
                display: inline-block;
            }

            .scoresTable p {
                display: inline-block;
                background: var(--paper-grey-300);
                padding: 8px;
                border-radius: 8px;
            }

            .scoresTable span {
                font-weight: bold;
            }

            .scores td {
                padding: 4px;
            }

            table {
                border-collapse: collapse;
                background: inherit;
            }

            table td,
            table th {
                border: 1px solid var(--paper-amber-50);
            }

            table tr:first-child th {
                border-top: 0;
            }

            table tr:last-child td {
                border-bottom: 0;
            }

            table tr td:first-child,
            table tr th:first-child {
                border-left: 0;
            }

            table tr td:last-child,
            table tr th:last-child {
                border-right: 0;
            }

            .raceCard p {
                margin: 0;
                margin-bottom: 0.25em;
            }

            .raceCard ul {
                margin: 0;
            }
        </style>

        <iron-form id="form">
            <form>
                <div class="card">
                    <div class="circle">2</div>
                    <h1>Create Character</h1>
                    <p>Name:
                        <iron-input bind-value="{{character.Name}}"><input pattern="[ a-zA-Z',]+"></iron-input>
                    </p>
                    <paper-button class="paperbutton" on-tap="reset" hidden$="[[scoresGenerated]]">Reset</paper-button>
                </div>
                <div class="card">
                    <div class="circle lineup">1</div>
                    <h2 class="lineup">Ability Scores</h2>
                    <br><label id="scoreMode">Generation Method:</label>
                    <paper-radio-group selected="{{scoreMode}}" aria-labelledby="scoreMode">
                        <paper-radio-button name="Standard">Standard</paper-radio-button>
                        <paper-radio-button name="Classic">Classic</paper-radio-button>
                        <paper-radio-button name="Heroic">Heroic</paper-radio-button>
                        <paper-radio-button name="Dice Pool" disabled>Dice Pool</paper-radio-button>
                        <paper-radio-button name="Purchase" disabled>Purchase</paper-radio-button>
                    </paper-radio-group><br>
                    <div class="scoresTable" hidden$="[[!scoresTable]]">
                        <h3>Rolls:</h3>
                        <template is="dom-repeat" items="{{scores}}" as="score">
                            <p><span>{{score.total}}</span> {{score.rolls}}</p>
                        </template>
                    </div>
                    <paper-button class="paperbutton" on-tap="_onGenerateScores" hidden$="[[scoresGenerated]]">Generate</paper-button>

                    <div class="card" hidden$=[[!scoresGenerated]]>
                        <table class="scores">
                            <tr>
                                <th>Score</th>
                                <th>Value</th>
                                <th>Assign Roll</th>
                            </tr>
                            <tr>
                                <td>Strength</td>
                                <td class="textCentred">{{character.Strength}}</td>
                                <td>
                                    <iron-selector id="Strength" attr-for-selected="name" on-selected-changed="_onSelectedScoreChanged">
                                        <template is="dom-repeat" items="{{scores}}" as="score">
                                            <div name="{{score.num}}">{{score.total}}</div>
                                        </template>
                                    </iron-selector>
                                </td>
                            </tr>
                            <tr>
                                <td>Dexterity</td>
                                <td class="textCentred">{{character.Dexterity}}</td>
                                <td>
                                    <iron-selector id="Dexterity" attr-for-selected="name" on-selected-changed="_onSelectedScoreChanged">
                                        <template is="dom-repeat" items="{{scores}}" as="score">
                                            <div name="{{score.num}}">{{score.total}}</div>
                                        </template>
                                    </iron-selector>
                                </td>
                            </tr>
                            <tr>
                                <td>Constitution</td>
                                <td class="textCentred">{{character.Constitution}}</td>
                                <td>
                                    <iron-selector id="Constitution" attr-for-selected="name" on-selected-changed="_onSelectedScoreChanged">
                                        <template is="dom-repeat" items="{{scores}}" as="score">
                                            <div name="{{score.num}}">{{score.total}}</div>
                                        </template>
                                    </iron-selector>
                                </td>
                            </tr>
                            <tr>
                                <td>Intelligence</td>
                                <td class="textCentred">{{character.Intelligence}}</td>
                                <td>
                                    <iron-selector id="Intelligence" attr-for-selected="name" on-selected-changed="_onSelectedScoreChanged">
                                        <template is="dom-repeat" items="{{scores}}" as="score">
                                            <div name="{{score.num}}">{{score.total}}</div>
                                        </template>
                                    </iron-selector>
                                </td>
                            </tr>
                            <tr>
                                <td>Wisdom</td>
                                <td class="textCentred">{{character.Wisdom}}</td>
                                <td>
                                    <iron-selector id="Wisdom" attr-for-selected="name" on-selected-changed="_onSelectedScoreChanged">
                                        <template is="dom-repeat" items="{{scores}}" as="score">
                                            <div name="{{score.num}}">{{score.total}}</div>
                                        </template>
                                    </iron-selector>
                                </td>
                            </tr>
                            <tr>
                                <td>Charisma</td>
                                <td class="textCentred">{{character.Charisma}}</td>
                                <td>
                                    <iron-selector id="Charisma" attr-for-selected="name" on-selected-changed="_onSelectedScoreChanged">
                                        <template is="dom-repeat" items="{{scores}}" as="score">
                                            <div name="{{score.num}}">{{score.total}}</div>
                                        </template>
                                    </iron-selector>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <firebase-query id="doc" path="/Races" data="{{Races}}" on-data-changed="_onDataChanged">
                </firebase-query>
                <div class="card">
                    <div class="circle lineup">1</div>
                    <h2 class="lineup">Races</h2>
                    <template is="dom-repeat" items="{{Races}}" as="race">
                        <div class="card raceCard">
                            <h3 class="cardtitle">{{race.Name}}</h3>
                            <p class="cardsubtitle">[[race.Type]] - [[race.Subtype]]</p>
                            <hr>
                            <div class="column3">
                                <p class="columnNoBreak">Race Points: [[race.Race_Point_Costs]]</p>
                                <p class="columnNoBreak">Size: [[race.Size]]</p>
                                <div class="columnNoBreak">Ability Scores:
                                    <ul>
                                        <li hidden$="[[!race.Scores.Strength]]">Strength [[race.Scores.Strength]]</li>
                                        <li hidden$="[[!race.Scores.Dexterity]]">Dexterity [[race.Scores.Dexterity]]</li>
                                        <li hidden$="[[!race.Scores.Constitution]]">Constitution [[race.Scores.Constitution]]</li>
                                        <li hidden$="[[!race.Scores.Intelligence]]">Intelligence [[race.Scores.Intelligence]]</li>
                                        <li hidden$="[[!race.Scores.Wisdom]]">Wisdom [[race.Scores.Wisdom]]</li>
                                        <li hidden$="[[!race.Scores.Charisma]]">Charisma [[race.Scores.Charisma]]</li>
                                    </ul>
                                </div>
                                <div class="columnNoBreak">Speed:
                                    <ul>
                                        <li hidden$="[[!race.Speeds.Land]]">Land [[race.Speeds.Land]]</li>
                                        <li hidden$="[[!race.Speeds.Swim]]">Swim [[race.Speeds.Swim]]</li>
                                        <li hidden$="[[!race.Speeds.Fly]]">Fly [[race.Speeds.Fly]]</li>
                                    </ul>
                                </div>
                                <div class="columnNoBreak">Known Languages:
                                    <ul>
                                        <template is="dom-repeat" items="[[_arrayText(race.Languages.Known)]]" as="lang">
                                            <li>[[lang]]</li>
                                        </template>
                                    </ul>
                                </div>
                                <div class="columnNoBreak">Available Languages:
                                    <ul>
                                        <template is="dom-repeat" items="[[_arrayText(race.Languages.Learn)]]" as="lang">
                                            <li>[[lang]]</li>
                                        </template>
                                    </ul>
                                </div>
                                <h4>Traits</h4>
                                <div>[[_spacing(race.Traits.Default)]]</div>
                            </div>
                    </template>
                    </div>

                    <paper-fab class="addbutton" on-tap="_onSubmit" label=">>>"></paper-fab>
            </form>
        </iron-form>
    </template>

    <script>
        class MyCreatecharacter extends Polymer.Element {
            static get is() { return 'my-createcharacter'; }
            ready() {
                super.ready();
                window.createcharacter = this;
            }

            static get properties() {
                return {
                    // Other properties
                    active: {
                        type: Boolean,
                        value: false,
                        observer: '_activeChanged',
                    },
                    character: {
                        type: Object,
                        observer: '_characterChanged',
                        value: {
                            Charisma: 0,
                            Constitution: 0,
                            Dexterity: 0,
                            Intelligence: 0,
                            Strength: 0,
                            Wisdom: 0,
                        }
                    },
                    scoreMode: {
                        type: String,
                        value: "Standard",
                        observer: '_onScoreMethodChanged'
                    },
                    scoresGenerated: {
                        type: Boolean,
                        value: false
                    },
                    scoresTable: {
                        type: Boolean,
                        value: false
                    },
                    scores: Array
                };
            }

            reset() {
                this.set("character.Name", "");
                this.resetScores();
                this.set("scoreMode", "Standard");
            }

            resetScores() {
                this.set("character.Charisma", 0);
                this.set("character.Constitution", 0);
                this.set("character.Dexterity", 0);
                this.set("character.Intelligence", 0);
                this.set("character.Strength", 0);
                this.set("character.Wisdom", 0);
                this.$.Charisma.select();
                this.$.Constitution.select();
                this.$.Dexterity.select();
                this.$.Intelligence.select();
                this.$.Strength.select();
                this.$.Wisdom.select();
            }

            _spacing(text) {
                return text.replace(/,/g, ", ");
            }

            _arrayText(text) {
                return text.split(",");
            }

            _activeChanged(active) {
                if (active) {
                    // this.reset();
                }
            }
            _characterChanged(character) {
                console.log(character);
            }

            _onDataChanged() {
            }

            _onScoreMethodChanged() {
                if (this.character) {
                    this.resetScores();
                }
                switch (this.scoreMode) {
                    case "Purchase":
                        this.scoresGenerated = true;
                        this.scoresTable = false;
                        break;
                    case "Dice Pool":
                        this.scoresGenerated = false;
                        this.scoresTable = true;
                    default:
                        this.scoresGenerated = false;
                        this.scoresTable = false;
                }
                this.scores = [];
            }

            _onGenerateScores() {
                this.scoresGenerated = true;
                this.scores = [];
                var dice = 0;
                switch (this.scoreMode) {
                    case "Classic":
                        dice = 3;
                        break;
                    case "Heroic":
                        dice = 2;
                        break;
                    default://Standard
                        dice = 4;
                }
                for (var i = 0; i < 6; i++) {
                    var rolls = this.global.rolls(dice, 6);
                    var results = JSON.stringify(rolls);
                    var total = 0;
                    if (this.scoreMode == "Heroic") {
                        total = rolls.pop() + rolls.pop() + 6;
                        results += " + 6";
                    } else {
                        rolls.sort();
                        total = rolls.pop() + rolls.pop() + rolls.pop();
                    }
                    this.scores.push({
                        num: i,
                        total: total,
                        rolls: results
                    });
                }
                this.scoresTable = true;
            }

            _onSelectedScoreChanged(event) {
                switch (event.srcElement.id) {
                    case "Charisma":
                        if (this.$.Constitution.selected == event.detail.value) {
                            this.$.Constitution.select();
                        }
                        if (this.$.Dexterity.selected == event.detail.value) {
                            this.$.Dexterity.select();
                        }
                        if (this.$.Intelligence.selected == event.detail.value) {
                            this.$.Intelligence.select();
                        }
                        if (this.$.Strength.selected == event.detail.value) {
                            this.$.Strength.select();
                        }
                        if (this.$.Wisdom.selected == event.detail.value) {
                            this.$.Wisdom.select();
                        }
                        break;
                    case "Constitution":
                        if (this.$.Charisma.selected == event.detail.value) {
                            this.$.Charisma.select();
                        }
                        if (this.$.Dexterity.selected == event.detail.value) {
                            this.$.Dexterity.select();
                        }
                        if (this.$.Intelligence.selected == event.detail.value) {
                            this.$.Intelligence.select();
                        }
                        if (this.$.Strength.selected == event.detail.value) {
                            this.$.Strength.select();
                        }
                        if (this.$.Wisdom.selected == event.detail.value) {
                            this.$.Wisdom.select();
                        }
                        break;
                    case "Dexterity":
                        if (this.$.Charisma.selected == event.detail.value) {
                            this.$.Charisma.select();
                        }
                        if (this.$.Constitution.selected == event.detail.value) {
                            this.$.Constitution.select();
                        }
                        if (this.$.Intelligence.selected == event.detail.value) {
                            this.$.Intelligence.select();
                        }
                        if (this.$.Strength.selected == event.detail.value) {
                            this.$.Strength.select();
                        }
                        if (this.$.Wisdom.selected == event.detail.value) {
                            this.$.Wisdom.select();
                        }
                        break;
                    case "Intelligence":
                        if (this.$.Charisma.selected == event.detail.value) {
                            this.$.Charisma.select();
                        }
                        if (this.$.Constitution.selected == event.detail.value) {
                            this.$.Constitution.select();
                        }
                        if (this.$.Dexterity.selected == event.detail.value) {
                            this.$.Dexterity.select();
                        }
                        if (this.$.Strength.selected == event.detail.value) {
                            this.$.Strength.select();
                        }
                        if (this.$.Wisdom.selected == event.detail.value) {
                            this.$.Wisdom.select();
                        }
                        break;
                    case "Strength":
                        if (this.$.Charisma.selected == event.detail.value) {
                            this.$.Charisma.select();
                        }
                        if (this.$.Constitution.selected == event.detail.value) {
                            this.$.Constitution.select();
                        }
                        if (this.$.Dexterity.selected == event.detail.value) {
                            this.$.Dexterity.select();
                        }
                        if (this.$.Intelligence.selected == event.detail.value) {
                            this.$.Intelligence.select();
                        }
                        if (this.$.Wisdom.selected == event.detail.value) {
                            this.$.Wisdom.select();
                        }
                        break;
                    case "Wisdom":
                        if (this.$.Charisma.selected == event.detail.value) {
                            this.$.Charisma.select();
                        }
                        if (this.$.Constitution.selected == event.detail.value) {
                            this.$.Constitution.select();
                        }
                        if (this.$.Dexterity.selected == event.detail.value) {
                            this.$.Dexterity.select();
                        }
                        if (this.$.Intelligence.selected == event.detail.value) {
                            this.$.Intelligence.select();
                        }
                        if (this.$.Strength.selected == event.detail.value) {
                            this.$.Strength.select();
                        }
                        break;
                }
                try {
                    this.set("character." + event.srcElement.id, this.scores[event.detail.value].total || 0);
                } catch (e) {
                    this.set("character." + event.srcElement.id, 0);
                }
            }

            _onSubmit() {
                //Validate and create - don't submit
                //TODO: 
                if (this.$.form.validate()) {
                    console.log(this.$.form.serializeForm());
                }
            }

        }

        window.customElements.define(MyCreatecharacter.is, MyCreatecharacter);
    </script>
</dom-module>